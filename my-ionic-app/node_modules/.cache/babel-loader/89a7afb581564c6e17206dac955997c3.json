{"ast":null,"code":"import _regeneratorRuntime from\"G:\\\\Mihnea\\\\Facultate\\\\anu 3\\\\Mobile\\\\start\\\\my-ionic-app\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/regenerator\";import _asyncToGenerator from\"G:\\\\Mihnea\\\\Facultate\\\\anu 3\\\\Mobile\\\\start\\\\my-ionic-app\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"G:\\\\Mihnea\\\\Facultate\\\\anu 3\\\\Mobile\\\\start\\\\my-ionic-app\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/slicedToArray\";import _toConsumableArray from\"G:\\\\Mihnea\\\\Facultate\\\\anu 3\\\\Mobile\\\\start\\\\my-ionic-app\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/toConsumableArray\";import _objectSpread from\"G:\\\\Mihnea\\\\Facultate\\\\anu 3\\\\Mobile\\\\start\\\\my-ionic-app\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/objectSpread2\";import React,{useCallback,useEffect,useReducer}from'react';import{getLogger}from'../core';import{createItem,getItems,newWebSocket,updateItem}from'./itemApi';var log=getLogger('ItemProvider');var initialState={fetching:false,saving:false};var FETCH_ITEMS_STARTED='FETCH_ITEMS_STARTED';var FETCH_ITEMS_SUCCEEDED='FETCH_ITEMS_SUCCEEDED';var FETCH_ITEMS_FAILED='FETCH_ITEMS_FAILED';var SAVE_ITEM_STARTED='SAVE_ITEM_STARTED';var SAVE_ITEM_SUCCEEDED='SAVE_ITEM_SUCCEEDED';var SAVE_ITEM_FAILED='SAVE_ITEM_FAILED';var reducer=function reducer(state,_ref){var type=_ref.type,payload=_ref.payload;switch(type){case FETCH_ITEMS_STARTED:return _objectSpread(_objectSpread({},state),{},{fetching:true,fetchingError:null});case FETCH_ITEMS_SUCCEEDED:return _objectSpread(_objectSpread({},state),{},{items:payload.items,fetching:false});case FETCH_ITEMS_FAILED:return _objectSpread(_objectSpread({},state),{},{fetchingError:payload.error,fetching:false});case SAVE_ITEM_STARTED:return _objectSpread(_objectSpread({},state),{},{savingError:null,saving:true});case SAVE_ITEM_SUCCEEDED:var items=_toConsumableArray(state.items||[]);var _item=payload.item;var index=items.findIndex(function(it){return it.id===_item.id;});if(index===-1){items.splice(0,0,_item);}else{items[index]=_item;}return _objectSpread(_objectSpread({},state),{},{items:items,saving:false});case SAVE_ITEM_FAILED:return _objectSpread(_objectSpread({},state),{},{savingError:payload.error,saving:false});default:return state;}};export var ItemContext=React.createContext(initialState);export var ItemProvider=function ItemProvider(_ref2){var children=_ref2.children;var _useReducer=useReducer(reducer,initialState),_useReducer2=_slicedToArray(_useReducer,2),state=_useReducer2[0],dispatch=_useReducer2[1];var items=state.items,fetching=state.fetching,fetchingError=state.fetchingError,saving=state.saving,savingError=state.savingError;useEffect(getItemsEffect,[]);useEffect(wsEffect,[]);var saveItem=useCallback(saveItemCallback,[]);var value={items:items,fetching:fetching,fetchingError:fetchingError,saving:saving,savingError:savingError,saveItem:saveItem};log('returns');return/*#__PURE__*/React.createElement(ItemContext.Provider,{value:value},children);function getItemsEffect(){var canceled=false;fetchItems();return function(){canceled=true;};function fetchItems(){return _fetchItems.apply(this,arguments);}function _fetchItems(){_fetchItems=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var _items;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;log('fetchItems started');dispatch({type:FETCH_ITEMS_STARTED});_context.next=5;return getItems();case 5:_items=_context.sent;log('fetchItems succeeded');if(!canceled){dispatch({type:FETCH_ITEMS_SUCCEEDED,payload:{items:_items}});}_context.next=14;break;case 10:_context.prev=10;_context.t0=_context[\"catch\"](0);log('fetchItems failed');dispatch({type:FETCH_ITEMS_FAILED,payload:{error:_context.t0}});case 14:case\"end\":return _context.stop();}}},_callee,null,[[0,10]]);}));return _fetchItems.apply(this,arguments);}}function saveItemCallback(_x){return _saveItemCallback.apply(this,arguments);}function _saveItemCallback(){_saveItemCallback=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(item){var savedItem;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;log('saveItem started');dispatch({type:SAVE_ITEM_STARTED});_context2.next=5;return item.id?updateItem(item):createItem(item);case 5:savedItem=_context2.sent;log('saveItem succeeded');dispatch({type:SAVE_ITEM_SUCCEEDED,payload:{item:savedItem}});_context2.next=14;break;case 10:_context2.prev=10;_context2.t0=_context2[\"catch\"](0);log('saveItem failed');dispatch({type:SAVE_ITEM_FAILED,payload:{error:_context2.t0}});case 14:case\"end\":return _context2.stop();}}},_callee2,null,[[0,10]]);}));return _saveItemCallback.apply(this,arguments);}function wsEffect(){var canceled=false;log('wsEffect - connecting');var closeWebSocket=newWebSocket(function(message){if(canceled){return;}var event=message.event,item=message.payload.item;log(\"ws message, item \".concat(event));if(event==='created'||event==='updated'){dispatch({type:SAVE_ITEM_SUCCEEDED,payload:{item:item}});}});return function(){log('wsEffect - disconnecting');canceled=true;closeWebSocket();};}};","map":{"version":3,"sources":["G:/Mihnea/Facultate/anu 3/Mobile/start/my-ionic-app/src/class/ItemProvider.tsx"],"names":["React","useCallback","useEffect","useReducer","getLogger","createItem","getItems","newWebSocket","updateItem","log","initialState","fetching","saving","FETCH_ITEMS_STARTED","FETCH_ITEMS_SUCCEEDED","FETCH_ITEMS_FAILED","SAVE_ITEM_STARTED","SAVE_ITEM_SUCCEEDED","SAVE_ITEM_FAILED","reducer","state","type","payload","fetchingError","items","error","savingError","item","index","findIndex","it","id","splice","ItemContext","createContext","ItemProvider","children","dispatch","getItemsEffect","wsEffect","saveItem","saveItemCallback","value","canceled","fetchItems","savedItem","closeWebSocket","message","event"],"mappings":"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","sourcesContent":["import React, { useCallback, useEffect, useReducer } from 'react';\r\nimport PropTypes from 'prop-types';\r\nimport { getLogger } from '../core';\r\nimport { ItemProps } from './ItemProps';\r\nimport { createItem, getItems, newWebSocket, updateItem } from './itemApi';\r\n\r\nconst log = getLogger('ItemProvider');\r\n\r\ntype SaveItemFn = (item: ItemProps) => Promise<any>;\r\n\r\nexport interface ItemsState {\r\n  items?: ItemProps[],\r\n  fetching: boolean,\r\n  fetchingError?: Error | null,\r\n  saving: boolean,\r\n  savingError?: Error | null,\r\n  saveItem?: SaveItemFn,\r\n}\r\n\r\ninterface ActionProps {\r\n  type: string,\r\n  payload?: any,\r\n}\r\n\r\nconst initialState: ItemsState = {\r\n  fetching: false,\r\n  saving: false,\r\n};\r\n\r\nconst FETCH_ITEMS_STARTED = 'FETCH_ITEMS_STARTED';\r\nconst FETCH_ITEMS_SUCCEEDED = 'FETCH_ITEMS_SUCCEEDED';\r\nconst FETCH_ITEMS_FAILED = 'FETCH_ITEMS_FAILED';\r\nconst SAVE_ITEM_STARTED = 'SAVE_ITEM_STARTED';\r\nconst SAVE_ITEM_SUCCEEDED = 'SAVE_ITEM_SUCCEEDED';\r\nconst SAVE_ITEM_FAILED = 'SAVE_ITEM_FAILED';\r\n\r\nconst reducer: (state: ItemsState, action: ActionProps) => ItemsState =\r\n  (state, { type, payload }) => {\r\n    switch (type) {\r\n      case FETCH_ITEMS_STARTED:\r\n        return { ...state, fetching: true, fetchingError: null };\r\n      case FETCH_ITEMS_SUCCEEDED:\r\n        return { ...state, items: payload.items, fetching: false };\r\n      case FETCH_ITEMS_FAILED:\r\n        return { ...state, fetchingError: payload.error, fetching: false };\r\n      case SAVE_ITEM_STARTED:\r\n        return { ...state, savingError: null, saving: true };\r\n      case SAVE_ITEM_SUCCEEDED:\r\n        const items = [...(state.items || [])];\r\n        const item = payload.item;\r\n        const index = items.findIndex(it => it.id === item.id);\r\n        if (index === -1) {\r\n          items.splice(0, 0, item);\r\n        } else {\r\n          items[index] = item;\r\n        }\r\n        return { ...state, items, saving: false };\r\n      case SAVE_ITEM_FAILED:\r\n        return { ...state, savingError: payload.error, saving: false };\r\n      default:\r\n        return state;\r\n    }\r\n  };\r\n\r\nexport const ItemContext = React.createContext<ItemsState>(initialState);\r\n\r\ninterface ItemProviderProps {\r\n  children: PropTypes.ReactNodeLike,\r\n}\r\n\r\nexport const ItemProvider: React.FC<ItemProviderProps> = ({ children }) => {\r\n  const [state, dispatch] = useReducer(reducer, initialState);\r\n  const { items, fetching, fetchingError, saving, savingError } = state;\r\n  useEffect(getItemsEffect, []);\r\n  useEffect(wsEffect, []);\r\n  const saveItem = useCallback<SaveItemFn>(saveItemCallback, []);\r\n  const value = { items, fetching, fetchingError, saving, savingError, saveItem };\r\n  log('returns');\r\n  return (\r\n    <ItemContext.Provider value={value}>\r\n      {children}\r\n    </ItemContext.Provider>\r\n  );\r\n\r\n  function getItemsEffect() {\r\n    let canceled = false;\r\n    fetchItems();\r\n    return () => {\r\n      canceled = true;\r\n    }\r\n\r\n    async function fetchItems() {\r\n      try {\r\n        log('fetchItems started');\r\n        dispatch({ type: FETCH_ITEMS_STARTED });\r\n        const items = await getItems();\r\n        log('fetchItems succeeded');\r\n        if (!canceled) {\r\n          dispatch({ type: FETCH_ITEMS_SUCCEEDED, payload: { items } });\r\n        }\r\n      } catch (error) {\r\n        log('fetchItems failed');\r\n        dispatch({ type: FETCH_ITEMS_FAILED, payload: { error } });\r\n      }\r\n    }\r\n  }\r\n\r\n  async function saveItemCallback(item: ItemProps) {\r\n    try {\r\n      log('saveItem started');\r\n      dispatch({ type: SAVE_ITEM_STARTED });\r\n      const savedItem = await (item.id ? updateItem(item) : createItem(item));\r\n      log('saveItem succeeded');\r\n      dispatch({ type: SAVE_ITEM_SUCCEEDED, payload: { item: savedItem } });\r\n    } catch (error) {\r\n      log('saveItem failed');\r\n      dispatch({ type: SAVE_ITEM_FAILED, payload: { error } });\r\n    }\r\n  }\r\n\r\n  function wsEffect() {\r\n    let canceled = false;\r\n    log('wsEffect - connecting');\r\n    const closeWebSocket = newWebSocket(message => {\r\n      if (canceled) {\r\n        return;\r\n      }\r\n      const { event, payload: { item }} = message;\r\n      log(`ws message, item ${event}`);\r\n      if (event === 'created' || event === 'updated') {\r\n        dispatch({ type: SAVE_ITEM_SUCCEEDED, payload: { item } });\r\n      }\r\n    });\r\n    return () => {\r\n      log('wsEffect - disconnecting');\r\n      canceled = true;\r\n      closeWebSocket();\r\n    }\r\n  }\r\n};\r\n"]},"metadata":{},"sourceType":"module"}